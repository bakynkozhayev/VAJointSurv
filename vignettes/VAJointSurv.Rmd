---
title: "Jount Survival and Marker Models"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{VAJointSurv}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

This package provides means of estimating joint models for a mixture of 
different types of markers and different types of survival outcomes. The models
are estimated with Gaussian variational approximations (GVAs). We will start 
by covering the model and then cover the implementation.

### The Markers
We assume that there are $L$ observed markers at each time point. We let 
$\vec Y_{ij}$ denote the $j$th observed markers for individual $i$ and let 
$s_{ij}$ be the observation time. The model for the markers is

$$
\begin{align*}
\vec Y_{ij}&= \vec\mu_i(s_{ij}, \vec U_i) + \vec\epsilon_{ij} \\
\epsilon_{ij} &\sim N^{(L)}(\vec 0, \Sigma) \\
\mu_{i1}(s, U) &= \vec x_{i1}^\top\vec\gamma_1 + \vec g_1(s)^\top\vec\beta_1 + 
  \vec m_1(s)^\top\vec U_{i1} \\
\vdots &\hphantom{=}\vdots\\\
\mu_{iL}(s, \vec U_i) &= \vec x_{iL}^\top\vec\gamma_L + \vec g_L(s)^\top\vec\beta_L + 
  \vec m_L(s)^\top\vec U_{iL} \\
\vec U_i  &= \begin{pmatrix}
    \vec U_{i1} \\ \vdots \\ \vec U_{iL}
  \end{pmatrix}\sim N^{(R)}(\vec0, \Psi) 
\end{align*}
$$

where $\vec\epsilon_{ij}$ is an error term of the observation, $\vec U_i$ is an 
unobserved random effect for individual $i$, and the $\vec g_k$s and $\vec m_k$s
are basis expansions.
We can write the model more compactly by letting 

$$G(s) = \begin{pmatrix} 
  \vec g_1(s)^\top & 0^\top & \cdots & \vec 0^\top \\
  \vec 0^\top & \vec g_2(s)^\top & \ddots & \vdots \\
  \vdots & \ddots & \ddots & \vec 0^\top \\
  \vec 0^\top & \cdots & \vec 0^\top & \vec g_L(s)^\top \end{pmatrix}$$
  
and defining $M(s)$ and $X_i$ similarly. Furthermore, let 
$\vec\gamma = (\vec\gamma_1^\top,\dots,\vec\gamma_L^\top)$ and define 
$\vec\beta$ similarly. Then 

$$
\vec\mu_i(s_{ij}, \vec U_i) = X_i\vec\gamma + G(s_{ij})\vec\gamma + M(s_{ij})\vec U_i
$$

### The Survival Outcomes
We assume that there are $H$ different types of survival outcomes. The 
conditional hazards of the survival outcomes are

$$
\begin{align*}
h_{i1}(t\mid \vec U_i, \vec\xi_i) &= \exp\left( 
  \vec z_{i1}^\top\vec \delta_1 + 
  \omega_1^\top \vec b_1(t) + 
  \vec\alpha_1^\top M(t)\vec U_i + \xi_{i1}
  \right) \\
\vdots &\hphantom{=}\vdots \\
h_{iH}(t\mid \vec U_i,\vec \xi_i) &= \exp\left(  
  \vec z_{iL}^\top\vec \delta_H + 
  \omega_H^\top\vec b_H(t) + 
  \vec\alpha_H^\top M(t)\vec U_i + \xi_{iH}
  \right) \\
\vec\xi_i = \begin{pmatrix}\xi_{i1} \\ \vdots \\ \xi_{iH}\end{pmatrix}
  &\sim N^{(H)}(\vec 0, \Xi)
\end{align*}
$$
The $\vec\alpha$s are associations parameters which makes the markers and the 
survival outcomes marginally dependent. The $\vec\xi_i$s are frailty effects 
which makes the survival outcomes marginally dependent even if 
$\vec\alpha = \vec 0$.

### Model Support

The library can handle 
 
 - Mixed type of basis expansions in $G$, $M$, and $b_1,\dots,b_H$.
 - Arbitrary number of markers, $L$, and survival outcomes, $H$.
 - Only observing a subset of the $L$ markers at a given point in time.
 - Any number of observed markers. 
 - Left-truncation and right-censoring. 
 - Multiple observed outcomes for each survival type for an individual $i$.
 
The following is not supported
 
 - Interval-censoring and left-censoring are not supported although this is not
   a complicated extension.
 - There cannot be more than one set of markers observed 
   at each point in time, $s_{ij}$, for each individual $i$.
   
## Technical Details
We define the concatenated coefficient vector to be

$$
\vec \theta = \begin{pmatrix}
  \vec\gamma_1 \\ \vec\beta_1 \\
  \vdots \\
  \vec\gamma_L \\ \vec\beta_L \\
  \vec\omega_1 \\ \vec\delta_1 \\ \vec\alpha_1 \\
  \vdots \\
  \vec\omega_H \\ \vec\delta_H \\ \vec\alpha_H \\
    \text{vec}(\Sigma) \\ \text{vec}(\Psi) \\ \text{vec}(\Xi)
\end{pmatrix}
$$

were $\text{vec}(\cdot)$ is vectorization which stacks the column of a matrix 
on top of each other. There are different types of terms in the lower bound 
in the GVA. We cover the types below.

## Kullback–Leibler Divergence Term
In the GVA, we assume that the conditional distribution of 
$(\vec U_i^\top, \vec\xi_i^\top)^\top$ is a normal distribution with mean 
$\vec\zeta_i$ and covariance matrix $\Omega_i$. 
One of the terms in the lower bound of the GVA is
Kullback–Leibler (KL) divergence term between the unconditional distribution of
$(\vec U_i^\top, \vec\xi_i^\top)^\top$ and the assumed conditional 
distribution. This term is given by 

$$
\begin{multline*}
\frac 12\Big(\log\lvert\Omega_i\rvert - 
  \log\lvert\Psi\rvert - \log\lvert\Xi\rvert 
  -\vec\zeta_{i,1:R}^\top\Psi^{-1}\vec\zeta_{i,1:R}
  -\vec\zeta_{i,(-1:R)}^\top\Xi^{-1}\vec\zeta_{i,(-1:R)} \\
  - \text{tr}\Omega_{i,1:R,1:R}\Psi^{-1}
  - \text{tr}\Omega_{i,(-1:R),(-1:R)}\Xi^{-1}
  + R + H\Big)
\end{multline*}
$$

where $\text{tr}(\cdot)$ returns the trace of a matrix.
Thus, the derivatives w.r.t. $\Omega_i$, $\Psi$, $\Xi$, $\vec\zeta$ are
respectively

$$
\frac 12\left(\Omega_i^{-1} - 
  \begin{pmatrix} \Psi^{-1} & 0 \\ 0 & \Xi^{-1}\end{pmatrix}\right) 
$$

$$
\frac 12
   \Psi^{-1}(\vec\zeta_{i,1:R}\vec\zeta_{i,1:R}^\top
   + \Omega_{i,1:R,1:R} - \Psi)\Psi^{-1}
$$

$$
\frac 12
   \Xi^{-1}(\vec\zeta_{i,(-1:R)}\vec\zeta_{i,(-1:R)}^\top
   + \Omega_{i,(-1:R),(-1:R)} - \Xi)\Xi^{-1}
$$

$$
-\begin{pmatrix}
  \Psi^{-1} & 0 \\
  0 & \Xi^{-1} 
\end{pmatrix}\vec\zeta
$$

## Marker Terms

The 
log conditional density term of observation $j$ of individual $i$ at time 
$s_{ij}$ is

$$
\int \log\phi^{(L)}\left(\vec y_{ij}; X_i\vec\gamma + G(s_{ij})\vec\beta 
  + M(s_{ij})\vec w, \Sigma\right)
  \phi^{(R)}\left(\vec w; \vec\zeta_{i,1:R}, \Omega_{i,1:R,1:R}\right) d\vec w
$$
which gives

$$
\begin{multline*}
-\frac L2\log 2\pi  -\frac 12 \log\lvert\Sigma \rvert 
  - \frac 12\left(\vec y_{ij} - X_i\vec\gamma - G(s_{ij})\vec\beta 
  - M(s_{ij})\vec\zeta_{i,1:R}\right)^\top \\
  \Sigma^{-1}\left(\vec y_{ij} - X_i\vec\gamma - G(s_{ij})\vec\beta 
  - M(s_{ij})\vec\zeta_{i,1:R}\right) - 
  \frac 12\text{tr}\Sigma^{-1}M(s_{ij})\Omega_{i,1:R,1:R}M(s_{ij})^\top
\end{multline*}
$$

## Survival Outcomes
Let $T_{i1}, \dots, T_{iL}$ be the minimum of the censoring time or 
the observed event time and $D_{i1}, \dots, D_{iL}$ be event indicators. The 
the lower bound terms for the $k$th time to event is

$$
\int \left(d_{ik}\log h_{ik}(t_{ik}\mid \vec w_{1:R}, w_{R + k})
  -\int_0^{t_{ik}}  h_{ik}(s\mid \vec w_{1:R}, w_{R + k})ds
  \right)\phi^{(R + H)}(\vec w; \vec\zeta_i, \Omega_i)d\vec w
$$

The log hazard term gives the following lower bound terms

$$
d_{ik}\left(\vec z_{ik}^\top\vec\delta_k + 
  \omega_k^\top \vec b_k(t_{ik}) + 
  \vec\alpha_k^\top M(t_{ik})\vec\zeta_{i,1:R} + \zeta_{i,R + k}\right)
$$

As for the expected cumulative hazard term, assume that we can interchange the order 
of integration. Then the lower bounds term is

$$
\xi_{ik} = -\exp(\vec z_{ik}^\top\vec\delta_k)\int_0^{t_{ij}}
  \exp\left(\omega_k^\top \vec b_k(s) + 
  + \zeta_{R + k } +\frac 12 
  (\vec\alpha_k^\top, 1) O_{ik}(s)\begin{pmatrix}
    \vec\alpha_k \\ 1
  \end{pmatrix}\right) ds
$$

where 

$$
O_{ik}(s) = \begin{pmatrix}M(s) & 0 \\ 0 & 1\end{pmatrix}
  \Omega_{(1:R, R + k), (1:R, R + k)}
    \begin{pmatrix}M(s)^\top & 0 \\ 0 & 1\end{pmatrix}
$$
