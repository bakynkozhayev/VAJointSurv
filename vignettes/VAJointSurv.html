<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />



<title>Joint Survival and Marker Models</title>

<script src="data:application/javascript;base64,Ly8gUGFuZG9jIDIuOSBhZGRzIGF0dHJpYnV0ZXMgb24gYm90aCBoZWFkZXIgYW5kIGRpdi4gV2UgcmVtb3ZlIHRoZSBmb3JtZXIgKHRvCi8vIGJlIGNvbXBhdGlibGUgd2l0aCB0aGUgYmVoYXZpb3Igb2YgUGFuZG9jIDwgMi44KS4KZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignRE9NQ29udGVudExvYWRlZCcsIGZ1bmN0aW9uKGUpIHsKICB2YXIgaHMgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKCJkaXYuc2VjdGlvbltjbGFzcyo9J2xldmVsJ10gPiA6Zmlyc3QtY2hpbGQiKTsKICB2YXIgaSwgaCwgYTsKICBmb3IgKGkgPSAwOyBpIDwgaHMubGVuZ3RoOyBpKyspIHsKICAgIGggPSBoc1tpXTsKICAgIGlmICghL15oWzEtNl0kL2kudGVzdChoLnRhZ05hbWUpKSBjb250aW51ZTsgIC8vIGl0IHNob3VsZCBiZSBhIGhlYWRlciBoMS1oNgogICAgYSA9IGguYXR0cmlidXRlczsKICAgIHdoaWxlIChhLmxlbmd0aCA+IDApIGgucmVtb3ZlQXR0cmlidXRlKGFbMF0ubmFtZSk7CiAgfQp9KTsK"></script>

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>


<style type="text/css">
  code {
    white-space: pre;
  }
  .sourceCode {
    overflow: visible;
  }
</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */

</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    for (var j = 0; j < rules.length; j++) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") continue;
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') continue;
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>




<link rel="stylesheet" href="data:text/css,body%20%7B%0Abackground%2Dcolor%3A%20%23fff%3B%0Amargin%3A%201em%20auto%3B%0Amax%2Dwidth%3A%20700px%3B%0Aoverflow%3A%20visible%3B%0Apadding%2Dleft%3A%202em%3B%0Apadding%2Dright%3A%202em%3B%0Afont%2Dfamily%3A%20%22Open%20Sans%22%2C%20%22Helvetica%20Neue%22%2C%20Helvetica%2C%20Arial%2C%20sans%2Dserif%3B%0Afont%2Dsize%3A%2014px%3B%0Aline%2Dheight%3A%201%2E35%3B%0A%7D%0A%23TOC%20%7B%0Aclear%3A%20both%3B%0Amargin%3A%200%200%2010px%2010px%3B%0Apadding%3A%204px%3B%0Awidth%3A%20400px%3B%0Aborder%3A%201px%20solid%20%23CCCCCC%3B%0Aborder%2Dradius%3A%205px%3B%0Abackground%2Dcolor%3A%20%23f6f6f6%3B%0Afont%2Dsize%3A%2013px%3B%0Aline%2Dheight%3A%201%2E3%3B%0A%7D%0A%23TOC%20%2Etoctitle%20%7B%0Afont%2Dweight%3A%20bold%3B%0Afont%2Dsize%3A%2015px%3B%0Amargin%2Dleft%3A%205px%3B%0A%7D%0A%23TOC%20ul%20%7B%0Apadding%2Dleft%3A%2040px%3B%0Amargin%2Dleft%3A%20%2D1%2E5em%3B%0Amargin%2Dtop%3A%205px%3B%0Amargin%2Dbottom%3A%205px%3B%0A%7D%0A%23TOC%20ul%20ul%20%7B%0Amargin%2Dleft%3A%20%2D2em%3B%0A%7D%0A%23TOC%20li%20%7B%0Aline%2Dheight%3A%2016px%3B%0A%7D%0Atable%20%7B%0Amargin%3A%201em%20auto%3B%0Aborder%2Dwidth%3A%201px%3B%0Aborder%2Dcolor%3A%20%23DDDDDD%3B%0Aborder%2Dstyle%3A%20outset%3B%0Aborder%2Dcollapse%3A%20collapse%3B%0A%7D%0Atable%20th%20%7B%0Aborder%2Dwidth%3A%202px%3B%0Apadding%3A%205px%3B%0Aborder%2Dstyle%3A%20inset%3B%0A%7D%0Atable%20td%20%7B%0Aborder%2Dwidth%3A%201px%3B%0Aborder%2Dstyle%3A%20inset%3B%0Aline%2Dheight%3A%2018px%3B%0Apadding%3A%205px%205px%3B%0A%7D%0Atable%2C%20table%20th%2C%20table%20td%20%7B%0Aborder%2Dleft%2Dstyle%3A%20none%3B%0Aborder%2Dright%2Dstyle%3A%20none%3B%0A%7D%0Atable%20thead%2C%20table%20tr%2Eeven%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0A%7D%0Ap%20%7B%0Amargin%3A%200%2E5em%200%3B%0A%7D%0Ablockquote%20%7B%0Abackground%2Dcolor%3A%20%23f6f6f6%3B%0Apadding%3A%200%2E25em%200%2E75em%3B%0A%7D%0Ahr%20%7B%0Aborder%2Dstyle%3A%20solid%3B%0Aborder%3A%20none%3B%0Aborder%2Dtop%3A%201px%20solid%20%23777%3B%0Amargin%3A%2028px%200%3B%0A%7D%0Adl%20%7B%0Amargin%2Dleft%3A%200%3B%0A%7D%0Adl%20dd%20%7B%0Amargin%2Dbottom%3A%2013px%3B%0Amargin%2Dleft%3A%2013px%3B%0A%7D%0Adl%20dt%20%7B%0Afont%2Dweight%3A%20bold%3B%0A%7D%0Aul%20%7B%0Amargin%2Dtop%3A%200%3B%0A%7D%0Aul%20li%20%7B%0Alist%2Dstyle%3A%20circle%20outside%3B%0A%7D%0Aul%20ul%20%7B%0Amargin%2Dbottom%3A%200%3B%0A%7D%0Apre%2C%20code%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0Aborder%2Dradius%3A%203px%3B%0Acolor%3A%20%23333%3B%0Awhite%2Dspace%3A%20pre%2Dwrap%3B%20%0A%7D%0Apre%20%7B%0Aborder%2Dradius%3A%203px%3B%0Amargin%3A%205px%200px%2010px%200px%3B%0Apadding%3A%2010px%3B%0A%7D%0Apre%3Anot%28%5Bclass%5D%29%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0A%7D%0Acode%20%7B%0Afont%2Dfamily%3A%20Consolas%2C%20Monaco%2C%20%27Courier%20New%27%2C%20monospace%3B%0Afont%2Dsize%3A%2085%25%3B%0A%7D%0Ap%20%3E%20code%2C%20li%20%3E%20code%20%7B%0Apadding%3A%202px%200px%3B%0A%7D%0Adiv%2Efigure%20%7B%0Atext%2Dalign%3A%20center%3B%0A%7D%0Aimg%20%7B%0Abackground%2Dcolor%3A%20%23FFFFFF%3B%0Apadding%3A%202px%3B%0Aborder%3A%201px%20solid%20%23DDDDDD%3B%0Aborder%2Dradius%3A%203px%3B%0Aborder%3A%201px%20solid%20%23CCCCCC%3B%0Amargin%3A%200%205px%3B%0A%7D%0Ah1%20%7B%0Amargin%2Dtop%3A%200%3B%0Afont%2Dsize%3A%2035px%3B%0Aline%2Dheight%3A%2040px%3B%0A%7D%0Ah2%20%7B%0Aborder%2Dbottom%3A%204px%20solid%20%23f7f7f7%3B%0Apadding%2Dtop%3A%2010px%3B%0Apadding%2Dbottom%3A%202px%3B%0Afont%2Dsize%3A%20145%25%3B%0A%7D%0Ah3%20%7B%0Aborder%2Dbottom%3A%202px%20solid%20%23f7f7f7%3B%0Apadding%2Dtop%3A%2010px%3B%0Afont%2Dsize%3A%20120%25%3B%0A%7D%0Ah4%20%7B%0Aborder%2Dbottom%3A%201px%20solid%20%23f7f7f7%3B%0Amargin%2Dleft%3A%208px%3B%0Afont%2Dsize%3A%20105%25%3B%0A%7D%0Ah5%2C%20h6%20%7B%0Aborder%2Dbottom%3A%201px%20solid%20%23ccc%3B%0Afont%2Dsize%3A%20105%25%3B%0A%7D%0Aa%20%7B%0Acolor%3A%20%230033dd%3B%0Atext%2Ddecoration%3A%20none%3B%0A%7D%0Aa%3Ahover%20%7B%0Acolor%3A%20%236666ff%3B%20%7D%0Aa%3Avisited%20%7B%0Acolor%3A%20%23800080%3B%20%7D%0Aa%3Avisited%3Ahover%20%7B%0Acolor%3A%20%23BB00BB%3B%20%7D%0Aa%5Bhref%5E%3D%22http%3A%22%5D%20%7B%0Atext%2Ddecoration%3A%20underline%3B%20%7D%0Aa%5Bhref%5E%3D%22https%3A%22%5D%20%7B%0Atext%2Ddecoration%3A%20underline%3B%20%7D%0A%0Acode%20%3E%20span%2Ekw%20%7B%20color%3A%20%23555%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%0Acode%20%3E%20span%2Edt%20%7B%20color%3A%20%23902000%3B%20%7D%20%0Acode%20%3E%20span%2Edv%20%7B%20color%3A%20%2340a070%3B%20%7D%20%0Acode%20%3E%20span%2Ebn%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Efl%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Ech%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Est%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Eco%20%7B%20color%3A%20%23888888%3B%20font%2Dstyle%3A%20italic%3B%20%7D%20%0Acode%20%3E%20span%2Eot%20%7B%20color%3A%20%23007020%3B%20%7D%20%0Acode%20%3E%20span%2Eal%20%7B%20color%3A%20%23ff0000%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%0Acode%20%3E%20span%2Efu%20%7B%20color%3A%20%23900%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%0Acode%20%3E%20span%2Eer%20%7B%20color%3A%20%23a61717%3B%20background%2Dcolor%3A%20%23e3d2d2%3B%20%7D%20%0A" type="text/css" />




</head>

<body>




<h1 class="title toc-ignore">Joint Survival and Marker Models</h1>



<p>This package provides means of estimating joint models for a mixture of different types of markers and different types of survival outcomes. The models are estimated with Gaussian variational approximations (GVAs). We will start by covering the model and then cover the implementation.</p>
<div id="the-markers" class="section level3">
<h3>The Markers</h3>
<p>We assume that there are <span class="math inline">\(L\)</span> observed markers at each time point. We let <span class="math inline">\(\vec Y_{ij}\)</span> denote the <span class="math inline">\(j\)</span>th observed markers for individual <span class="math inline">\(i\)</span> and let <span class="math inline">\(s_{ij}\)</span> be the observation time. The model for the markers is</p>
<p><span class="math display">\[
\begin{align*}
\vec Y_{ij}&amp;= \vec\mu_i(s_{ij}, \vec U_i) + \vec\epsilon_{ij} \\
\epsilon_{ij} &amp;\sim N^{(L)}(\vec 0, \Sigma) \\
\mu_{i1}(s, U) &amp;= \vec x_{i1}^\top\vec\gamma_1 + \vec g_1(s)^\top\vec\beta_1 + 
  \vec m_1(s)^\top\vec U_{i1} \\
\vdots &amp;\hphantom{=}\vdots\\\
\mu_{iL}(s, \vec U_i) &amp;= \vec x_{iL}^\top\vec\gamma_L + \vec g_L(s)^\top\vec\beta_L + 
  \vec m_L(s)^\top\vec U_{iL} \\
\vec U_i  &amp;= \begin{pmatrix}
    \vec U_{i1} \\ \vdots \\ \vec U_{iL}
  \end{pmatrix}\sim N^{(R)}(\vec0, \Psi) 
\end{align*}
\]</span></p>
<p>where <span class="math inline">\(\vec\epsilon_{ij}\)</span> is an error term of the observation, <span class="math inline">\(\vec U_i\)</span> is an unobserved random effect for individual <span class="math inline">\(i\)</span>, and the <span class="math inline">\(\vec g_k\)</span>s and <span class="math inline">\(\vec m_k\)</span>s are basis expansions. We can write the model more compactly by letting</p>
<p><span class="math display">\[G(s) = \begin{pmatrix} 
  \vec g_1(s)^\top &amp; 0^\top &amp; \cdots &amp; \vec 0^\top \\
  \vec 0^\top &amp; \vec g_2(s)^\top &amp; \ddots &amp; \vdots \\
  \vdots &amp; \ddots &amp; \ddots &amp; \vec 0^\top \\
  \vec 0^\top &amp; \cdots &amp; \vec 0^\top &amp; \vec g_L(s)^\top \end{pmatrix}\]</span></p>
<p>and defining <span class="math inline">\(M(s)\)</span> and <span class="math inline">\(X_i\)</span> similarly. Furthermore, let <span class="math inline">\(\vec\gamma = (\vec\gamma_1^\top,\dots,\vec\gamma_L^\top)\)</span> and define <span class="math inline">\(\vec\beta\)</span> similarly. Then</p>
<p><span class="math display">\[
\vec\mu_i(s_{ij}, \vec U_i) = X_i\vec\gamma + G(s_{ij})\vec\beta + M(s_{ij})\vec U_i
\]</span></p>
</div>
<div id="the-survival-outcomes" class="section level3">
<h3>The Survival Outcomes</h3>
<p>We assume that there are <span class="math inline">\(H\)</span> different types of survival outcomes. The conditional hazards of the survival outcomes are</p>
<p><span class="math display">\[
\begin{align*}
h_{i1}(t\mid \vec U_i, \vec\xi_i) &amp;= \exp\left( 
  \vec z_{i1}^\top\vec \delta_1 + 
  \omega_1^\top \vec b_1(t) + 
  \vec\alpha_1^\top M(t)\vec U_i + \xi_{i1}
  \right) \\
\vdots &amp;\hphantom{=}\vdots \\
h_{iH}(t\mid \vec U_i,\vec \xi_i) &amp;= \exp\left(  
  \vec z_{iL}^\top\vec \delta_H + 
  \omega_H^\top\vec b_H(t) + 
  \vec\alpha_H^\top M(t)\vec U_i + \xi_{iH}
  \right) \\
\vec\xi_i = \begin{pmatrix}\xi_{i1} \\ \vdots \\ \xi_{iH}\end{pmatrix}
  &amp;\sim N^{(H)}(\vec 0, \Xi)
\end{align*}
\]</span> The <span class="math inline">\(\vec\alpha\)</span>s are associations parameters which makes the markers and the survival outcomes marginally dependent. The <span class="math inline">\(\vec\xi_i\)</span>s are frailty effects which makes the survival outcomes marginally dependent even if <span class="math inline">\(\vec\alpha = \vec 0\)</span>.</p>
</div>
<div id="model-support" class="section level3">
<h3>Model Support</h3>
<p>The library can handle</p>
<ul>
<li>Mixed type of basis expansions in <span class="math inline">\(G\)</span>, <span class="math inline">\(M\)</span>, and <span class="math inline">\(b_1,\dots,b_H\)</span>.</li>
<li>Arbitrary number of markers, <span class="math inline">\(L\)</span>, and survival outcomes, <span class="math inline">\(H\)</span>.</li>
<li>Only observing a subset of the <span class="math inline">\(L\)</span> markers at a given point in time.</li>
<li>Any number of observed markers.</li>
<li>Left-truncation and right-censoring.</li>
<li>Multiple observed outcomes for each survival type for an individual <span class="math inline">\(i\)</span>.</li>
</ul>
<p>The following is not supported</p>
<ul>
<li>Interval-censoring and left-censoring are not supported although this is not a complicated extension.</li>
<li>One may want either want the integral or the derivatives of <span class="math inline">\(M(t)\)</span> with respect to <span class="math inline">\(t\)</span> in the log-hazards. This is not too complicated to implement for many of the basis expansions in the package but it is not yet implemented.</li>
<li>There cannot be more than one set of markers observed at each point in time, <span class="math inline">\(s_{ij}\)</span>, for each individual <span class="math inline">\(i\)</span>.</li>
</ul>
</div>
<div id="examples" class="section level2">
<h2>Examples</h2>
<p>We show a few examples of this package and its API below.</p>
<div id="univariate-marker-example" class="section level3">
<h3>Univariate Marker Example</h3>
<p>We make a comparison below with one marker only with the lme4 package. We do this as we can check that</p>
<ul>
<li>We get almost the same (the lower bound can be equal to the log marginal likelihood).</li>
<li>The lower bound is less than or equal to the log marginal likelihood.</li>
</ul>
<p>lme4 should used in this case as the linear model is tractable and this is used by the lme4 package.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># settings for the simulation</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(splines)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>g_func <span class="ot">&lt;-</span> <span class="cf">function</span>(x)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ns</span>(x, <span class="at">knots =</span> <span class="fu">c</span>(.<span class="dv">5</span>, <span class="fl">1.5</span>), <span class="at">Boundary.knots =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">2</span>), <span class="at">intercept =</span> <span class="cn">FALSE</span>)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>m_func <span class="ot">&lt;-</span> <span class="cf">function</span>(x)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ns</span>(x, <span class="at">knots =</span> <span class="dv">1</span>, <span class="at">Boundary.knots =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">2</span>), <span class="at">intercept =</span> <span class="cn">TRUE</span>)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>fixef_vary_marker <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fl">1.4</span>, <span class="sc">-</span><span class="fl">1.2</span>, <span class="sc">-</span><span class="fl">2.1</span>) <span class="co"># beta</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>fixef_marker <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="sc">-</span>.<span class="dv">5</span>, <span class="dv">1</span>) <span class="co"># gamma</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>Psi <span class="ot">&lt;-</span> <span class="fu">structure</span>(<span class="fu">c</span>(<span class="fl">0.18</span>, <span class="fl">0.05</span>, <span class="sc">-</span><span class="fl">0.05</span>, <span class="fl">0.05</span>, <span class="fl">0.34</span>, <span class="sc">-</span><span class="fl">0.25</span>, <span class="sc">-</span><span class="fl">0.05</span>, <span class="sc">-</span><span class="fl">0.25</span>, <span class="fl">0.24</span>), </span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>                 <span class="at">.Dim =</span> <span class="fu">c</span>(3L, 3L))</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>Sig <span class="ot">&lt;-</span> <span class="fu">matrix</span>(.<span class="dv">6</span><span class="sc">^</span><span class="dv">2</span>, <span class="dv">1</span>)</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mvtnorm)</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="co"># simulates from the model by sampling a given number of individuals</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>sim_dat_univariate <span class="ot">&lt;-</span> <span class="cf">function</span>(n_ids){</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>  <span class="co"># simulate the outcomes</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>  sig_sqrt <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(Sig)</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>  dat <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span>n_ids, <span class="cf">function</span>(id){</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># sample the number of outcomes and the fixed effect covariates</span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>    n_obs <span class="ot">&lt;-</span> <span class="fu">sample.int</span>(8L, 1L)</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>    obs_time <span class="ot">&lt;-</span> <span class="fu">sort</span>(<span class="fu">runif</span>(n_obs, <span class="dv">0</span>, <span class="dv">2</span>))</span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>    X <span class="ot">&lt;-</span> <span class="fu">cbind</span>(<span class="dv">1</span>, <span class="fu">rnorm</span>(n_obs))</span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">colnames</span>(X) <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">&quot;X&quot;</span>, <span class="dv">1</span><span class="sc">:</span><span class="fu">NCOL</span>(X) <span class="sc">-</span> 1L)</span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>    <span class="co"># sample the outcomes</span></span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>    U <span class="ot">&lt;-</span> <span class="fu">drop</span>(<span class="fu">rmvnorm</span>(<span class="dv">1</span>, <span class="at">sigma =</span> Psi))</span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a>    eta <span class="ot">&lt;-</span> X <span class="sc">%*%</span> fixef_marker <span class="sc">+</span> <span class="fu">drop</span>(<span class="fu">g_func</span>(obs_time)) <span class="sc">%*%</span> fixef_vary_marker <span class="sc">+</span> </span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>      <span class="fu">drop</span>(<span class="fu">m_func</span>(obs_time)) <span class="sc">%*%</span> U</span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a>    y <span class="ot">&lt;-</span> <span class="fu">drop</span>(eta) <span class="sc">+</span> <span class="fu">rnorm</span>(n_obs, <span class="at">sd =</span> sig_sqrt)</span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cbind</span>(<span class="at">y =</span> y, <span class="at">X =</span> X[, <span class="sc">-</span><span class="dv">1</span>, <span class="at">drop =</span> <span class="cn">FALSE</span>], <span class="at">time =</span> obs_time, <span class="at">id =</span> id)</span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a>  <span class="co"># combine the data and return</span></span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a>  out <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">do.call</span>(rbind, dat))</span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a>  out<span class="sc">$</span>id <span class="ot">&lt;-</span> <span class="fu">as.integer</span>(out<span class="sc">$</span>id)</span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a>  out</span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a><span class="co"># sample a moderately large data set</span></span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">2</span>)</span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> <span class="fu">sim_dat_univariate</span>(2000L)</span>
<span id="cb1-45"><a href="#cb1-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-46"><a href="#cb1-46" aria-hidden="true" tabindex="-1"></a><span class="co"># the number of observed outcomes</span></span>
<span id="cb1-47"><a href="#cb1-47" aria-hidden="true" tabindex="-1"></a><span class="fu">nrow</span>(dat)</span>
<span id="cb1-48"><a href="#cb1-48" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] 8992</span></span>
<span id="cb1-49"><a href="#cb1-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-50"><a href="#cb1-50" aria-hidden="true" tabindex="-1"></a><span class="co"># fit the model with lme4</span></span>
<span id="cb1-51"><a href="#cb1-51" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lme4)</span>
<span id="cb1-52"><a href="#cb1-52" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>(</span>
<span id="cb1-53"><a href="#cb1-53" aria-hidden="true" tabindex="-1"></a>  fit <span class="ot">&lt;-</span> <span class="fu">lmer</span>(y <span class="sc">~</span> X1 <span class="sc">+</span> <span class="fu">g_func</span>(time) <span class="sc">+</span> (<span class="fu">m_func</span>(time) <span class="sc">-</span> <span class="dv">1</span><span class="sc">|</span> id), dat, </span>
<span id="cb1-54"><a href="#cb1-54" aria-hidden="true" tabindex="-1"></a>              <span class="at">control =</span> <span class="fu">lmerControl</span>(<span class="at">optimizer =</span> <span class="st">&quot;bobyqa&quot;</span>),</span>
<span id="cb1-55"><a href="#cb1-55" aria-hidden="true" tabindex="-1"></a>              <span class="co"># to compare with the lower bound from this package</span></span>
<span id="cb1-56"><a href="#cb1-56" aria-hidden="true" tabindex="-1"></a>              <span class="at">REML =</span> <span class="cn">FALSE</span>))</span>
<span id="cb1-57"><a href="#cb1-57" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;    user  system elapsed </span></span>
<span id="cb1-58"><a href="#cb1-58" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;   0.792   0.000   0.792</span></span>
<span id="cb1-59"><a href="#cb1-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-60"><a href="#cb1-60" aria-hidden="true" tabindex="-1"></a><span class="co"># the maximum log likelihood</span></span>
<span id="cb1-61"><a href="#cb1-61" aria-hidden="true" tabindex="-1"></a><span class="fu">logLik</span>(fit)</span>
<span id="cb1-62"><a href="#cb1-62" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; &#39;log Lik.&#39; -9162 (df=12)</span></span>
<span id="cb1-63"><a href="#cb1-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-64"><a href="#cb1-64" aria-hidden="true" tabindex="-1"></a><span class="co"># estimate the model with this package. Get the object we need for the </span></span>
<span id="cb1-65"><a href="#cb1-65" aria-hidden="true" tabindex="-1"></a><span class="co"># optimization</span></span>
<span id="cb1-66"><a href="#cb1-66" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(VAJointSurv)</span>
<span id="cb1-67"><a href="#cb1-67" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>(comp_obj <span class="ot">&lt;-</span> <span class="fu">joint_ms_ptr</span>(</span>
<span id="cb1-68"><a href="#cb1-68" aria-hidden="true" tabindex="-1"></a>  <span class="at">markers =</span> <span class="fu">marker_term</span>(</span>
<span id="cb1-69"><a href="#cb1-69" aria-hidden="true" tabindex="-1"></a>    y <span class="sc">~</span> X1, <span class="at">id =</span> id, dat, </span>
<span id="cb1-70"><a href="#cb1-70" aria-hidden="true" tabindex="-1"></a>    <span class="at">time_fixef =</span> <span class="fu">ns_term</span>(time, <span class="at">knots =</span> <span class="fu">c</span>(.<span class="dv">5</span>, <span class="fl">1.5</span>), <span class="at">Boundary.knots =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">2</span>), </span>
<span id="cb1-71"><a href="#cb1-71" aria-hidden="true" tabindex="-1"></a>                         <span class="at">intercept =</span> <span class="cn">FALSE</span>),</span>
<span id="cb1-72"><a href="#cb1-72" aria-hidden="true" tabindex="-1"></a>    <span class="at">time_rng =</span> <span class="fu">ns_term</span>(time, <span class="at">knots =</span> <span class="dv">1</span>, <span class="at">Boundary.knots =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">2</span>), </span>
<span id="cb1-73"><a href="#cb1-73" aria-hidden="true" tabindex="-1"></a>                       <span class="at">intercept =</span> <span class="cn">TRUE</span>))))</span>
<span id="cb1-74"><a href="#cb1-74" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;    user  system elapsed </span></span>
<span id="cb1-75"><a href="#cb1-75" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;    0.12    0.00    0.12</span></span>
<span id="cb1-76"><a href="#cb1-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-77"><a href="#cb1-77" aria-hidden="true" tabindex="-1"></a><span class="co"># get the starting values</span></span>
<span id="cb1-78"><a href="#cb1-78" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>(start_val <span class="ot">&lt;-</span> <span class="fu">joint_ms_start_val</span>(comp_obj))</span>
<span id="cb1-79"><a href="#cb1-79" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;    user  system elapsed </span></span>
<span id="cb1-80"><a href="#cb1-80" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;   0.105   0.000   0.105</span></span>
<span id="cb1-81"><a href="#cb1-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-82"><a href="#cb1-82" aria-hidden="true" tabindex="-1"></a><span class="co"># lower bound at the starting values</span></span>
<span id="cb1-83"><a href="#cb1-83" aria-hidden="true" tabindex="-1"></a><span class="fu">attr</span>(start_val, <span class="st">&quot;value&quot;</span>)</span>
<span id="cb1-84"><a href="#cb1-84" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] 9788</span></span>
<span id="cb1-85"><a href="#cb1-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-86"><a href="#cb1-86" aria-hidden="true" tabindex="-1"></a><span class="co"># check that the gradient is correct</span></span>
<span id="cb1-87"><a href="#cb1-87" aria-hidden="true" tabindex="-1"></a>f <span class="ot">&lt;-</span> <span class="cf">function</span>(x){</span>
<span id="cb1-88"><a href="#cb1-88" aria-hidden="true" tabindex="-1"></a>  start_val[<span class="fu">seq_along</span>(x)] <span class="ot">&lt;-</span> x</span>
<span id="cb1-89"><a href="#cb1-89" aria-hidden="true" tabindex="-1"></a>  <span class="fu">joint_ms_lb</span>(comp_obj, start_val)</span>
<span id="cb1-90"><a href="#cb1-90" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-91"><a href="#cb1-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-92"><a href="#cb1-92" aria-hidden="true" tabindex="-1"></a><span class="fu">all.equal</span>(numDeriv<span class="sc">::</span><span class="fu">grad</span>(f, <span class="fu">head</span>(start_val, <span class="dv">12</span> <span class="sc">+</span> <span class="dv">2</span> <span class="sc">*</span> <span class="dv">9</span>)), </span>
<span id="cb1-93"><a href="#cb1-93" aria-hidden="true" tabindex="-1"></a>          <span class="fu">head</span>(<span class="fu">joint_ms_lb_gr</span>(comp_obj, start_val), <span class="dv">12</span> <span class="sc">+</span> <span class="dv">2</span> <span class="sc">*</span> <span class="dv">9</span>))</span>
<span id="cb1-94"><a href="#cb1-94" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] TRUE</span></span>
<span id="cb1-95"><a href="#cb1-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-96"><a href="#cb1-96" aria-hidden="true" tabindex="-1"></a><span class="co"># find the maximum lower bound estimate</span></span>
<span id="cb1-97"><a href="#cb1-97" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>(opt_out <span class="ot">&lt;-</span> <span class="fu">joint_ms_opt</span>(comp_obj, <span class="at">par =</span> start_val, <span class="at">max_it =</span> 1000L))</span>
<span id="cb1-98"><a href="#cb1-98" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;    user  system elapsed </span></span>
<span id="cb1-99"><a href="#cb1-99" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;   2.839   0.000   2.838</span></span>
<span id="cb1-100"><a href="#cb1-100" aria-hidden="true" tabindex="-1"></a>opt_out<span class="sc">$</span>info <span class="co"># convergence code (0 == &#39;ok&#39;)</span></span>
<span id="cb1-101"><a href="#cb1-101" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] 0</span></span>
<span id="cb1-102"><a href="#cb1-102" aria-hidden="true" tabindex="-1"></a><span class="sc">-</span>opt_out<span class="sc">$</span>value <span class="co"># maximum lower bound value</span></span>
<span id="cb1-103"><a href="#cb1-103" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] -9162</span></span>
<span id="cb1-104"><a href="#cb1-104" aria-hidden="true" tabindex="-1"></a><span class="fu">logLik</span>(fit) <span class="co"># maximum likelihood from lme4</span></span>
<span id="cb1-105"><a href="#cb1-105" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; &#39;log Lik.&#39; -9162 (df=12)</span></span>
<span id="cb1-106"><a href="#cb1-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-107"><a href="#cb1-107" aria-hidden="true" tabindex="-1"></a><span class="co"># compare the estimates with the actual values. Start with the fixed effects</span></span>
<span id="cb1-108"><a href="#cb1-108" aria-hidden="true" tabindex="-1"></a>fmt_ests <span class="ot">&lt;-</span> <span class="fu">joint_ms_format</span>(comp_obj, opt_out<span class="sc">$</span>par)</span>
<span id="cb1-109"><a href="#cb1-109" aria-hidden="true" tabindex="-1"></a><span class="fu">rbind</span>(<span class="at">lme4    =</span> <span class="fu">fixef</span>(fit),</span>
<span id="cb1-110"><a href="#cb1-110" aria-hidden="true" tabindex="-1"></a>      <span class="st">`</span><span class="at">This package</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">do.call</span>(c, fmt_ests<span class="sc">$</span>markers[[<span class="dv">1</span>]]), </span>
<span id="cb1-111"><a href="#cb1-111" aria-hidden="true" tabindex="-1"></a>      <span class="at">Actual    =</span> <span class="fu">c</span>(fixef_marker, fixef_vary_marker))</span>
<span id="cb1-112"><a href="#cb1-112" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;              (Intercept)    X1 g_func(time)1 g_func(time)2 g_func(time)3</span></span>
<span id="cb1-113"><a href="#cb1-113" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; lme4             -0.5206 1.007         1.372        -1.104        -2.089</span></span>
<span id="cb1-114"><a href="#cb1-114" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; This package     -0.5208 1.007         1.372        -1.104        -2.089</span></span>
<span id="cb1-115"><a href="#cb1-115" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Actual           -0.5000 1.000         1.400        -1.200        -2.100</span></span>
<span id="cb1-116"><a href="#cb1-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-117"><a href="#cb1-117" aria-hidden="true" tabindex="-1"></a><span class="co"># then the random effect covariance matrix</span></span>
<span id="cb1-118"><a href="#cb1-118" aria-hidden="true" tabindex="-1"></a>vcov_est <span class="ot">&lt;-</span> <span class="fu">VarCorr</span>(fit)[[<span class="st">&quot;id&quot;</span>]]</span>
<span id="cb1-119"><a href="#cb1-119" aria-hidden="true" tabindex="-1"></a><span class="fu">attributes</span>(vcov_est)[<span class="fu">c</span>(<span class="st">&quot;stddev&quot;</span>, <span class="st">&quot;correlation&quot;</span>)] <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb1-120"><a href="#cb1-120" aria-hidden="true" tabindex="-1"></a>vcov_est <span class="co"># lme4</span></span>
<span id="cb1-121"><a href="#cb1-121" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;               m_func(time)1 m_func(time)2 m_func(time)3</span></span>
<span id="cb1-122"><a href="#cb1-122" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; m_func(time)1       0.16228       0.09634      -0.04534</span></span>
<span id="cb1-123"><a href="#cb1-123" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; m_func(time)2       0.09634       0.29559      -0.26821</span></span>
<span id="cb1-124"><a href="#cb1-124" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; m_func(time)3      -0.04534      -0.26821       0.29652</span></span>
<span id="cb1-125"><a href="#cb1-125" aria-hidden="true" tabindex="-1"></a>fmt_ests<span class="sc">$</span>vcov<span class="sc">$</span>vcov_vary <span class="co"># this package</span></span>
<span id="cb1-126"><a href="#cb1-126" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;          [,1]     [,2]    [,3]</span></span>
<span id="cb1-127"><a href="#cb1-127" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1,]  0.16559  0.09389 -0.0482</span></span>
<span id="cb1-128"><a href="#cb1-128" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [2,]  0.09389  0.29793 -0.2661</span></span>
<span id="cb1-129"><a href="#cb1-129" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [3,] -0.04820 -0.26614  0.2978</span></span>
<span id="cb1-130"><a href="#cb1-130" aria-hidden="true" tabindex="-1"></a>Psi <span class="co"># the actual values</span></span>
<span id="cb1-131"><a href="#cb1-131" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;       [,1]  [,2]  [,3]</span></span>
<span id="cb1-132"><a href="#cb1-132" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1,]  0.18  0.05 -0.05</span></span>
<span id="cb1-133"><a href="#cb1-133" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [2,]  0.05  0.34 -0.25</span></span>
<span id="cb1-134"><a href="#cb1-134" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [3,] -0.05 -0.25  0.24</span></span>
<span id="cb1-135"><a href="#cb1-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-136"><a href="#cb1-136" aria-hidden="true" tabindex="-1"></a><span class="co"># the error term variance</span></span>
<span id="cb1-137"><a href="#cb1-137" aria-hidden="true" tabindex="-1"></a><span class="fu">c</span>(<span class="at">lme4 =</span> <span class="fu">attr</span>(<span class="fu">VarCorr</span>(fit), <span class="st">&quot;sc&quot;</span>)<span class="sc">^</span><span class="dv">2</span>, </span>
<span id="cb1-138"><a href="#cb1-138" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">This package</span><span class="st">`</span> <span class="ot">=</span> fmt_ests<span class="sc">$</span>vcov<span class="sc">$</span>vcov_marker, </span>
<span id="cb1-139"><a href="#cb1-139" aria-hidden="true" tabindex="-1"></a>  <span class="at">Actual =</span> Sig)</span>
<span id="cb1-140"><a href="#cb1-140" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;         lme4 This package       Actual </span></span>
<span id="cb1-141"><a href="#cb1-141" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;       0.3667       0.3662       0.3600</span></span></code></pre></div>
</div>
</div>
<div id="technical-details" class="section level2">
<h2>Technical Details</h2>
<p>We define the concatenated coefficient vector to be</p>
<p><span class="math display">\[
\vec \theta = \begin{pmatrix}
  \vec\gamma \\ \vec\beta\\
  \vec\omega_1 \\ \vec\delta_1 \\ \vec\alpha_1 \\
  \vdots \\
  \vec\omega_H \\ \vec\delta_H \\ \vec\alpha_H \\
    \text{vec}(\Sigma) \\ \text{vec}(\Psi) \\ \text{vec}(\Xi)
\end{pmatrix}
\]</span></p>
<p>where <span class="math inline">\(\text{vec}(\cdot)\)</span> is the vectorization function that stacks the column of a matrix on top of each other. There are different types of terms in the lower bound in the GVA. We cover the types below.</p>
</div>
<div id="kullbackleibler-divergence-term" class="section level2">
<h2>Kullback–Leibler Divergence Term</h2>
<p>In the GVA, we assume that the conditional distribution of <span class="math inline">\((\vec U_i^\top, \vec\xi_i^\top)^\top\)</span> is a normal distribution with mean <span class="math inline">\(\vec\zeta_i\)</span> and covariance matrix <span class="math inline">\(\Omega_i\)</span>. One of the terms in the lower bound of the GVA is the Kullback–Leibler (KL) divergence term between the unconditional distribution of <span class="math inline">\((\vec U_i^\top, \vec\xi_i^\top)^\top\)</span> and the assumed conditional distribution. This term is given by</p>
<p><span class="math display">\[
\begin{multline*}
\frac 12\Big(\log\lvert\Omega_i\rvert - 
  \log\lvert\Psi\rvert - \log\lvert\Xi\rvert 
  -\vec\zeta_{i,1:R}^\top\Psi^{-1}\vec\zeta_{i,1:R}
  -\vec\zeta_{i,(-1:R)}^\top\Xi^{-1}\vec\zeta_{i,(-1:R)} \\
  - \text{tr}\Omega_{i,1:R,1:R}\Psi^{-1}
  - \text{tr}\Omega_{i,(-1:R),(-1:R)}\Xi^{-1}
  + R + H\Big)
\end{multline*}
\]</span></p>
<p>where <span class="math inline">\(\text{tr}(\cdot)\)</span> returns the trace of a matrix. Thus, the derivatives w.r.t. <span class="math inline">\(\Omega_i\)</span>, <span class="math inline">\(\Psi\)</span>, <span class="math inline">\(\Xi\)</span>, <span class="math inline">\(\vec\zeta_i\)</span> are respectively</p>
<p><span class="math display">\[
\frac 12\left(\Omega_i^{-1} - 
  \begin{pmatrix} \Psi^{-1} &amp; 0 \\ 0 &amp; \Xi^{-1}\end{pmatrix}\right) 
\]</span></p>
<p><span class="math display">\[
\frac 12
   \Psi^{-1}(\vec\zeta_{i,1:R}\vec\zeta_{i,1:R}^\top
   + \Omega_{i,1:R,1:R} - \Psi)\Psi^{-1}
\]</span></p>
<p><span class="math display">\[
\frac 12
   \Xi^{-1}(\vec\zeta_{i,(-1:R)}\vec\zeta_{i,(-1:R)}^\top
   + \Omega_{i,(-1:R),(-1:R)} - \Xi)\Xi^{-1}
\]</span></p>
<p><span class="math display">\[
-\begin{pmatrix}
  \Psi^{-1} &amp; 0 \\
  0 &amp; \Xi^{-1} 
\end{pmatrix}\vec\zeta_i
\]</span></p>
</div>
<div id="marker-terms" class="section level2">
<h2>Marker Terms</h2>
<p>The log conditional density term of observation <span class="math inline">\(j\)</span> of individual <span class="math inline">\(i\)</span> at time <span class="math inline">\(s_{ij}\)</span> is</p>
<p><span class="math display">\[
\int \log\left(\phi^{(L)}\left(\vec y_{ij}; X_i\vec\gamma + G(s_{ij})\vec\beta 
  + M(s_{ij})\vec w, \Sigma\right)\right)
  \phi^{(R)}\left(\vec w; \vec\zeta_{i,1:R}, \Omega_{i,1:R,1:R}\right) d\vec w
\]</span> which gives</p>
<p><span class="math display">\[
\begin{multline*}
-\frac L2\log 2\pi  -\frac 12 \log\lvert\Sigma \rvert 
  - \frac 12\left(\vec y_{ij} - X_i\vec\gamma - G(s_{ij})\vec\beta 
  - M(s_{ij})\vec\zeta_{i,1:R}\right)^\top \\
  \Sigma^{-1}\left(\vec y_{ij} - X_i\vec\gamma - G(s_{ij})\vec\beta 
  - M(s_{ij})\vec\zeta_{i,1:R}\right) - 
  \frac 12\text{tr}\Sigma^{-1}M(s_{ij})\Omega_{i,1:R,1:R}M(s_{ij})^\top
\end{multline*}
\]</span></p>
</div>
<div id="survival-outcomes" class="section level2">
<h2>Survival Outcomes</h2>
<p>Let <span class="math inline">\(T_{i1}, \dots, T_{iL}\)</span> be the minimum of the censoring time or the observed event time and <span class="math inline">\(D_{i1}, \dots, D_{iL}\)</span> be event indicators. The the lower bound terms for the <span class="math inline">\(k\)</span>th time to event is</p>
<p><span class="math display">\[
\int \left(d_{ik}\log h_{ik}(t_{ik}\mid \vec w_{1:R}, w_{R + k})
  -\int_0^{t_{ik}}  h_{ik}(s\mid \vec w_{1:R}, w_{R + k})ds
  \right)\phi^{(R + H)}(\vec w; \vec\zeta_i, \Omega_i)d\vec w
\]</span></p>
<p>The log hazard term gives the following lower bound terms</p>
<p><span class="math display">\[
d_{ik}\left(\vec z_{ik}^\top\vec\delta_k + 
  \omega_k^\top \vec b_k(t_{ik}) + 
  \vec\alpha_k^\top M(t_{ik})\vec\zeta_{i,1:R} + \zeta_{i,R + k}\right)
\]</span></p>
<p>As for the expected cumulative hazard term, assume that we can interchange the order of integration. Then the lower bounds term is</p>
<p><span class="math display">\[
\xi_{ik} = -\exp(\vec z_{ik}^\top\vec\delta_k)\int_0^{t_{ij}}
  \exp\left(\omega_k^\top \vec b_k(s) + 
  + \zeta_{R + k } +\frac 12 
  (\vec\alpha_k^\top, 1) O_{ik}(s)\begin{pmatrix}
    \vec\alpha_k \\ 1
  \end{pmatrix}\right) ds
\]</span></p>
<p>where</p>
<p><span class="math display">\[
O_{ik}(s) = \begin{pmatrix}M(s) &amp; 0 \\ 0 &amp; 1\end{pmatrix}
  \Omega_{(1:R, R + k), (1:R, R + k)}
    \begin{pmatrix}M(s)^\top &amp; 0 \\ 0 &amp; 1\end{pmatrix}
\]</span></p>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
